## 参考：

- https://www.woshipm.com/pd/5685661.html
- https://www.woshipm.com/pd/4353196.html
- https://www.woshipm.com/pd/5184398.html **什么是租户**

1. 导语：SaaS产品，多租户必然是SaaS的天然属性之一；多租户意味着应用逻辑层面的隔离，如何好单租户以及多租户才是SaaS 应用多租户设计的核心关注点；

2. 为什么要搭建多租户系统 上层服务是供应商对外售卖的软件服务，其可以为客户创造价值、为公司带来营收； 底层多租户系统则是SaaS模式实现的具体方式，公司在对外售卖SaaS服务时，要考虑如何实现客户之间的**数据隔离、服务的权限控制、计费管理**等；因此需要引入多租户概念来解决上述问题。

3. 多租户技术，是一种**软件架构技术**，它是在探讨与实现如何于**多用户**的环境下**共享相同的系统或程序组**件，并且仍可确保各用户间资料的**隔离性**；简单来说是指一个**单独的实例可以为多个组织服务**。

4. 租户概念的理解。租户是指被赋予了SaaS服务使用权的**企业组织，即客户**。

5. 多租户与单租户的区别。

- 多租户（saas）：是多个客户使用同一个实例，数据存储在相同的位置，通过数据库、数据表和tenantID字段三种方式进行数据隔离，适合标准化程度较高的场景；
- 单租户（私有化）：是指多个客户使用多个实例，各个客户使用的实例和数据存储单独运行，更适合定制化需求场景。

6. 三者之间的区别是，aPaaS/PaaS/开放平台是软件服务供应商为第三方提供帮助/服务的工具，多租户系统则是软件服务商为自己的软件服务提供帮助的工具。

7. 服务模式上，SaaS服务采用按需订购模式；在底层设计上，SaaS服务核心点在于数据隔离与数据安全；

8. 多租户系统主要解决以下几个层面的需求：

- **租户注册与身份认证、账号管理、权限配置；**
- **计费方式、定价、收费、支付、欠费；**
- **应用增删改查、代码接入教程、应用监控、统计报表、消息中心；**
- **数据存储方案、安全机制；**
- ![多租户系统的基本功能清单](./../../../lei-items/assets/谈谈对多租户系统的简要理解/1669270864113.png)

9. 多租户系统使用者是**客户、公司内部管理员(admin)**，可将多租户系统的功能划分为两类：面向公司内部管理员和面向客户，两类功能通过权限来进行数据范围访问控制。
10. 面向公司内部管理员的功能主要有：**租户管理、产品管理、计费管理中的计费方案、权限管理、运营管理**；面向客户的功能主要有：**权限管理、应用管理、运营管理、计费管理中的充值、账单**等。



### 1. 租户管理

客户接入服务时，需提供公司名称、机构代码等信息，经过审核后创建租户账号，租户账号中的产品权限、功能权限等配置可根据客户选择接入的产品版本自动配置；或者由商务线下沟通，线上手动完成配置。

### 2. 产品管理、计费管理

SaaS服务对外售卖时会分为多个不同的版本，比如按用量或按功能来划分，因此一般需设计多种计费方案，公司按照不同的计费方案来配置产品版本和权限。

客户使用不同的产品版本时，涉及到购买、账户充值、支付、账单管理，以及续费、欠费、产品升级等。

### 3. 权限管理

客户的公司在使用服务时，总会涉及到权限问题：哪些人只能使用服务的一个功能，哪些数据只能高层看等等，这时可以通过对角色和用户进行权限分配。

一般来说，先设置角色，对角色赋予权限，然后再将角色赋予到用户上，这样用户就有了该角色所拥有的权限，需要进行权限修改时，只需修改角色的权限就可。

在用户管理中可以导入客户公司的组织架构，包括人员、岗位、部门等，对特定人员、岗位、部门赋予角色权限就可。

### 4. 应用管理

有的SaaS服务需要先接入SDK进行使用，这时就需要客户先创建应用，添加SDK代码；公司提供SDK接入教程、接口规则、接入限制等；当应用调用服务时，一般需要校验签名、防止乱塞数据。

### 5. 运营管理

客户和公司都需要对服务的使用情况进行监控，通过统计报表进行可视化展示，当出现异常情况或服务快到期时，进行消息提醒。

### 6. 数据隔离与安全

数据隔离和数据安全是图中没有体现出来的部分，但实际上体现在每一个使用环节。

数据隔离方式分为三类：独立数据库、共享数据库通过数据表隔离、共享数据库和表通过字段隔离；一般来说，数据隔离可以按租户和租户下面的应用两种方式进行隔离。

数据安全包括应用和敏感数据加密、身份认证、权限控制、网络监控、数据传输、IP地址管控、黑白名单等。

### 多租户系统的设计

有了功能模块之后，如何将功能模块串联起来，只有在实际的业务场景中跑的通的系统才有价值，这也能帮助我们对多租户系统的设计有更全面的认知。

一个典型的SaaS服务购买流程是：免费试用申请→demo体验→付费购买→使用服务→续费or取消服务。

将这一过程展开，可得到下面具体的业务流程。
![](./../../../lei-items/assets/谈谈对多租户系统的简要理解/1669272911688.png)

### 有几个注意事项：

1）多租户系统和SaaS服务系统使用同一套账号体系，同一用户免费试用和正式付费阶段账号不变，通过权限控制访问范围就可。

2）免费试用阶段可以给客户提供两个选择，接入SDK和不接入SDK试用demo，后者是mock数据让客户体验，但正式付费后还是需要接入SDK。

3）SDK接入之后，会先在测试环境跑通，在发布到生产环境，两个环境通过参数进行区分。

4）计费方案中期限和使用额度应该配置在租户账号下还是配置在具体的应用下？分不同情况而定：

一般来说，对于按量（调用次数、人数等）售卖的SaaS服务来说，期限和使用额度配置在租户账号下，也就是说，SaaS服务供应商不需要关心客户具体是怎么使用的服务的，只需要在租户层面控制服务的使用期限和使用额度就好。

另外一种情况，对于按以单个应用为服务整体不可拆分的SaaS服务来说，使用期限配置在应用层面，比如腾讯云的移动应用安全产品。

5）免费试用到期和正式付费后不再续费的租户，一般会由商务进行跟进，如果完成不了转化，对于这些到期账号下的数据，一般在保存1个月后自动删除

### 后记

至此，一个简单的多租户系统就搭建起来了，可大概窥见全貌；但是，实际上，这套多租户体系中仍然有非常多需要深挖的细节，比如权限管理、计费方案设计等，后续会出文章补充。

11. SaaS资源隔离包含几个层次

- 第一层是SaaS系统底层所涉及到的计算、存储、网络等资源的隔离。
- 第二层是系统基础数据的隔离，主要包括组织，用户，角色，权限，产品能力授权关系等。
- 第三层是系统使用过程中，各类业务动态数据的隔离，例如业务单据、操作记录等。 多租户架构主要是解决第一层的**隔离问题，即计算、存储、网络等资源的隔离**。为了实现多租户隔离架构，我们先要搞清楚常见的几种多租户隔离模式。

## 什么是租户
租户意为，某一个客户（一般是B类的企业），为使用一套SaaS的能力，所开辟出来的一个**公用的信息空间**
某公司租赁了一幢公寓作为销售宿舍，租期1年，同时，也购买了1年期限的SaaS系统。在这两个场景中，宿舍，和开通的SaaS系统，均是租户。**员工宿舍，拥有一个门牌号，即对应开通SaaS系统的租户ID**。

公司在两地购买了多套的公寓，而王五，常常出差，所以他的房卡，能打开杭州和北京两套公寓的房门。**这对应到SaaS系统中，就是一个账号，可以登录进入多个不同的SaaS租户中**。


## SaaS 系统的权限，就是账户的功能权限和数据权限的合集
功能权限是账号在平台上能看到哪些页面，能操作页面里面的哪些**功能或按钮**。
数据权限就是这个账号能在系统中看到哪些数据，能对哪些**数据做功能级的操作**。
功能权限一般靠角色和功能集进行关联，即**RBAC模型**。数据权限一般靠靠**租户的组织架构来实现数据的隔离**。
然后账号和角色关联，获得功能权限，和组织架构关联，获得可管理的数据。下面对相应内容做详细介绍。